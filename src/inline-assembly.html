<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Встроенный ассемблерный код</title>

    <link rel="stylesheet" type="text/css" href="../rustbook.css">

    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
                <div id="nav">
                    <button id="toggle-nav">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </button>
                </div>
<div id='toc' class='mobile-hidden'>
<ol class='chapter'>
<li><a  href='../README.html'><b>1.</b> Introduction</a>
</li>
<li><a  href='../src/INTRODUCTION.html'><b>2.</b> Введение</a>
</li>
<li><a  href='../src/getting-started.html'><b>3.</b> C чего начать</a>
</li>
<li><a  href='../src/learn-rust.html'><b>4.</b> Изучение Rust</a>
<ol class='section'>
<li><a  href='../src/guessing-game.html'><b>4.1.</b> Угадайка</a>
</li>
<li><a  href='../src/dining-philosophers.html'><b>4.2.</b> Обедающие философы</a>
</li>
<li><a  href='../src/rust-inside-other-languages.html'><b>4.3.</b> Вызов кода на Rust из других языков</a>
</li>
</ol>
</li>
<li><a  href='../src/syntax-and-semantics.html'><b>5.</b> Синтаксис и семантика</a>
<ol class='section'>
<li><a  href='../src/variable-bindings.html'><b>5.1.</b> Связывание имён</a>
</li>
<li><a  href='../src/functions.html'><b>5.2.</b> Функции</a>
</li>
<li><a  href='../src/primitive-types.html'><b>5.3.</b> Простые типы</a>
</li>
<li><a  href='../src/comments.html'><b>5.4.</b> Комментарии</a>
</li>
<li><a  href='../src/if.html'><b>5.5.</b> Конструкция `if`</a>
</li>
<li><a  href='../src/loops.html'><b>5.6.</b> Циклы</a>
</li>
<li><a  href='../src/ownership.html'><b>5.7.</b> Владение</a>
</li>
<li><a  href='../src/references-and-borrowing.html'><b>5.8.</b> Ссылки и заимствование</a>
</li>
<li><a  href='../src/lifetimes.html'><b>5.9.</b> Время жизни</a>
</li>
<li><a  href='../src/mutability.html'><b>5.10.</b> Изменяемость</a>
</li>
<li><a  href='../src/structs.html'><b>5.11.</b> Структуры</a>
</li>
<li><a  href='../src/enums.html'><b>5.12.</b> Перечисления</a>
</li>
<li><a  href='../src/match.html'><b>5.13.</b> Конструкция `match`</a>
</li>
<li><a  href='../src/patterns.html'><b>5.14.</b> Шаблоны сопоставления `match`</a>
</li>
<li><a  href='../src/method-syntax.html'><b>5.15.</b> Синтаксис методов</a>
</li>
<li><a  href='../src/vectors.html'><b>5.16.</b> Вектора</a>
</li>
<li><a  href='../src/strings.html'><b>5.17.</b> Строки</a>
</li>
<li><a  href='../src/generics.html'><b>5.18.</b> Обобщённое программирование</a>
</li>
<li><a  href='../src/traits.html'><b>5.19.</b> Типажи</a>
</li>
<li><a  href='../src/drop.html'><b>5.20.</b> Типаж `Drop`</a>
</li>
<li><a  href='../src/if-let.html'><b>5.21.</b> Конструкция `if let`</a>
</li>
<li><a  href='../src/trait-objects.html'><b>5.22.</b> Типажи-объекты</a>
</li>
<li><a  href='../src/closures.html'><b>5.23.</b> Замыкания</a>
</li>
<li><a  href='../src/ufcs.html'><b>5.24.</b> Универсальный синтаксис вызова функций</a>
</li>
<li><a  href='../src/crates-and-modules.html'><b>5.25.</b> Контейнеры и модули</a>
</li>
<li><a  href='../src/const-and-static.html'><b>5.26.</b> `const` и `static`</a>
</li>
<li><a  href='../src/attributes.html'><b>5.27.</b> Атрибуты</a>
</li>
<li><a  href='../src/type-aliases.html'><b>5.28.</b> Псевдонимы типов</a>
</li>
<li><a  href='../src/casting-between-types.html'><b>5.29.</b> Приведение типов</a>
</li>
<li><a  href='../src/associated-types.html'><b>5.30.</b> Ассоциированные типы</a>
</li>
<li><a  href='../src/unsized-types.html'><b>5.31.</b> Безразмерные типы</a>
</li>
<li><a  href='../src/operators-and-overloading.html'><b>5.32.</b> Перегрузка операций</a>
</li>
<li><a  href='../src/deref-coercions.html'><b>5.33.</b> Преобразования при разыменовании</a>
</li>
<li><a  href='../src/macros.html'><b>5.34.</b> Макросы</a>
</li>
<li><a  href='../src/raw-pointers.html'><b>5.35.</b> Сырые указатели</a>
</li>
<li><a  href='../src/unsafe.html'><b>5.36.</b> Небезопасный код</a>
</li>
</ol>
</li>
<li><a  href='../src/effective-rust.html'><b>6.</b> Эффективное использование Rust</a>
<ol class='section'>
<li><a  href='../src/the-stack-and-the-heap.html'><b>6.1.</b> Стек и куча</a>
</li>
<li><a  href='../src/testing.html'><b>6.2.</b> Тестирование</a>
</li>
<li><a  href='../src/conditional-compilation.html'><b>6.3.</b> Условная компиляция</a>
</li>
<li><a  href='../src/documentation.html'><b>6.4.</b> Документация</a>
</li>
<li><a  href='../src/iterators.html'><b>6.5.</b> Итераторы</a>
</li>
<li><a  href='../src/concurrency.html'><b>6.6.</b> Многозадачность</a>
</li>
<li><a  href='../src/error-handling.html'><b>6.7.</b> Обработка ошибок</a>
</li>
<li><a  href='../src/choosing-your-guarantees.html'><b>6.8.</b> Выбор гарантий</a>
</li>
<li><a  href='../src/ffi.html'><b>6.9.</b> Интерфейс внешних функций</a>
</li>
<li><a  href='../src/borrow-and-asref.html'><b>6.10.</b> Типажи `Borrow` и `AsRef`</a>
</li>
<li><a  href='../src/release-channels.html'><b>6.11.</b> Каналы сборок</a>
</li>
<li><a  href='../src/using-rust-without-the-standard-library.html'><b>6.12.</b> Using Rust without the standard library</a>
</li>
</ol>
</li>
<li><a  href='../src/nightly-rust.html'><b>7.</b> Нестабильные возможности Rust</a>
<ol class='section'>
<li><a  href='../src/compiler-plugins.html'><b>7.1.</b> Плагины к компилятору</a>
</li>
<li><a class='active' href='../src/inline-assembly.html'><b>7.2.</b> Встроенный ассемблерный код</a>
</li>
<li><a  href='../src/no-stdlib.html'><b>7.3.</b> Без stdlib</a>
</li>
<li><a  href='../src/intrinsics.html'><b>7.4.</b> Внутренние средства</a>
</li>
<li><a  href='../src/lang-items.html'><b>7.5.</b> Элементы языка</a>
</li>
<li><a  href='../src/advanced-linking.html'><b>7.6.</b> Продвинутое руководство по компоновке</a>
</li>
<li><a  href='../src/benchmark-tests.html'><b>7.7.</b> Тесты производительности</a>
</li>
<li><a  href='../src/box-syntax-and-patterns.html'><b>7.8.</b> Синтаксис упаковки и шаблоны `match`</a>
</li>
<li><a  href='../src/slice-patterns.html'><b>7.9.</b> Шаблоны `match` для срезов</a>
</li>
<li><a  href='../src/associated-constants.html'><b>7.10.</b> Ассоциированные константы</a>
</li>
<li><a  href='../src/custom-allocators.html'><b>7.11.</b> Пользовательские менеджеры памяти</a>
</li>
</ol>
</li>
<li><a  href='../src/glossary.html'><b>8.</b> Глоссарий</a>
</li>
<li><a  href='../src/syntax-index.html'><b>9.</b> Syntax Index</a>
</li>
<li><a  href='../src/bibliography.html'><b>10.</b> Библиография</a>
</li>
</ol>
</div>
<div id='page-wrapper'>
<div id='page'>


    <h1 class="title">Встроенный ассемблерный код</h1>
    <p>Если вам нужно работать на самом низком уровне или повысить производительность
программы, то у вас может возникнуть необходимость управлять процессором
напрямую. Rust поддерживает использование встроенного ассемблера и делает это с
помощью с помощью макроса <code>asm!</code>. Синтаксис примерно соответствует синтаксису
GCC и Clang:</p>

<pre class="rust rust-example-rendered">
<span class="macro">asm</span><span class="macro">!</span>(<span class="ident">assembly</span> <span class="ident">template</span>
   : <span class="ident">output</span> <span class="ident">operands</span>
   : <span class="ident">input</span> <span class="ident">operands</span>
   : <span class="ident">clobbers</span>
   : <span class="ident">options</span>
   );<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Aasm!(assembly%20template%0A%20%20%20%3A%20output%20operands%0A%20%20%20%3A%20input%20operands%0A%20%20%20%3A%20clobbers%0A%20%20%20%3A%20options%0A%20%20%20)%3B%0A%7D">Run</a></pre>

<p>Использование <code>asm</code> является закрытой возможностью (требуется указать
<code>#![feature(asm)]</code> для контейнера, чтобы разрешить ее использование) и, конечно
же, требует <code>unsafe</code> блока.</p>

<blockquote>
<p><strong>Примечание</strong>: здесь примеры приведены для x86/x86-64 ассемблера, но
поддерживаются все платформы.</p>
</blockquote>

<h2 id='Шаблон-инструкции-ассемблера' class='section-header'><a href='#Шаблон-инструкции-ассемблера'>Шаблон инструкции ассемблера</a></h2>
<p>Шаблон инструкции ассемблера (assembly template) является единственным
обязательным параметром, и он должен быть представлен строкой символов (т.е.
<code>&quot;&quot;</code>)</p>

<pre class="rust rust-example-rendered">
<span class="attribute">#<span class="op">!</span>[<span class="ident">feature</span>(<span class="ident">asm</span>)]</span>

<span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">any</span>(<span class="ident">target_arch</span> <span class="op">=</span> <span class="string">&quot;x86&quot;</span>, <span class="ident">target_arch</span> <span class="op">=</span> <span class="string">&quot;x86_64&quot;</span>))]</span>
<span class="kw">fn</span> <span class="ident">foo</span>() {
    <span class="kw">unsafe</span> {
        <span class="macro">asm</span><span class="macro">!</span>(<span class="string">&quot;NOP&quot;</span>);
    }
}

<span class="comment">// other platforms</span>
<span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">any</span>(<span class="ident">target_arch</span> <span class="op">=</span> <span class="string">&quot;x86&quot;</span>, <span class="ident">target_arch</span> <span class="op">=</span> <span class="string">&quot;x86_64&quot;</span>)))]</span>
<span class="kw">fn</span> <span class="ident">foo</span>() { <span class="comment">/* ... */</span> }

<span class="kw">fn</span> <span class="ident">main</span>() {
    <span class="comment">// ...</span>
    <span class="ident">foo</span>();
    <span class="comment">// ...</span>
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Bfeature(asm)%5D%0A%0A%23%5Bcfg(any(target_arch%20%3D%20%22x86%22%2C%20target_arch%20%3D%20%22x86_64%22))%5D%0Afn%20foo()%20%7B%0A%20%20%20%20unsafe%20%7B%0A%20%20%20%20%20%20%20%20asm!(%22NOP%22)%3B%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20other%20platforms%0A%23%5Bcfg(not(any(target_arch%20%3D%20%22x86%22%2C%20target_arch%20%3D%20%22x86_64%22)))%5D%0Afn%20foo()%20%7B%20%2F*%20...%20*%2F%20%7D%0A%0Afn%20main()%20%7B%0A%20%20%20%20%2F%2F%20...%0A%20%20%20%20foo()%3B%0A%20%20%20%20%2F%2F%20...%0A%7D%0A&amp;version=nightly">Run</a></pre>

<p>(Далее атрибуты <code>feature(asm)</code> и <code>#[cfg]</code> будут опущены.)</p>

<p>Выходные операнды (output operands), входные операнды (input operands),
затираемое (clobbers) и опции (options) не являются обязательными, но вы должны
будете добавить соответствующее количество <code>:</code> если хотите пропустить их:</p>

<pre class="rust rust-example-rendered">
<span class="macro">asm</span><span class="macro">!</span>(<span class="string">&quot;xor %eax, %eax&quot;</span>
    :
    :
    : <span class="string">&quot;{eax}&quot;</span>
   );<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Bfeature(asm)%5D%0A%23%5Bcfg(any(target_arch%20%3D%20%22x86%22%2C%20target_arch%20%3D%20%22x86_64%22))%5D%0Afn%20main()%20%7B%20unsafe%20%7B%0Aasm!(%22xor%20%25eax%2C%20%25eax%22%0A%20%20%20%20%3A%0A%20%20%20%20%3A%0A%20%20%20%20%3A%20%22%7Beax%7D%22%0A%20%20%20)%3B%0A%7D%20%7D%0A&amp;version=nightly">Run</a></pre>

<p>Пробелы и отступы также не имеют значения:</p>

<pre class="rust rust-example-rendered">
<span class="macro">asm</span><span class="macro">!</span>(<span class="string">&quot;xor %eax, %eax&quot;</span> ::: <span class="string">&quot;{eax}&quot;</span>);<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Bfeature(asm)%5D%0A%23%5Bcfg(any(target_arch%20%3D%20%22x86%22%2C%20target_arch%20%3D%20%22x86_64%22))%5D%0Afn%20main()%20%7B%20unsafe%20%7B%0Aasm!(%22xor%20%25eax%2C%20%25eax%22%20%3A%3A%3A%20%22%7Beax%7D%22)%3B%0A%7D%20%7D%0A&amp;version=nightly">Run</a></pre>

<h2 id='Операнды' class='section-header'><a href='#Операнды'>Операнды</a></h2>
<p>Входные и выходные операнды имеют одинаковый формат:
<code>:&quot;ограничение1&quot;(выражение1), &quot;ограничение2&quot;(выражение2), ...&quot;</code>. Выражения для
выходных операндов должны быть либо изменяемыми, либо неизменяемыми, но еще не
инициализированными, L-значениями:</p>

<pre class="rust rust-example-rendered">
<span class="kw">fn</span> <span class="ident">add</span>(<span class="ident">a</span>: <span class="ident">i32</span>, <span class="ident">b</span>: <span class="ident">i32</span>) <span class="op">-&gt;</span> <span class="ident">i32</span> {
    <span class="kw">let</span> <span class="ident">c</span>: <span class="ident">i32</span>;
    <span class="kw">unsafe</span> {
        <span class="macro">asm</span><span class="macro">!</span>(<span class="string">&quot;add $2, $0&quot;</span>
             : <span class="string">&quot;=r&quot;</span>(<span class="ident">c</span>)
             : <span class="string">&quot;0&quot;</span>(<span class="ident">a</span>), <span class="string">&quot;r&quot;</span>(<span class="ident">b</span>)
             );
    }
    <span class="ident">c</span>
}

<span class="kw">fn</span> <span class="ident">main</span>() {
    <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">add</span>(<span class="number">3</span>, <span class="number">14159</span>), <span class="number">14162</span>)
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Bfeature(asm)%5D%0A%23%5Bcfg(any(target_arch%20%3D%20%22x86%22%2C%20target_arch%20%3D%20%22x86_64%22))%5D%0Afn%20add(a%3A%20i32%2C%20b%3A%20i32)%20-%3E%20i32%20%7B%0A%20%20%20%20let%20c%3A%20i32%3B%0A%20%20%20%20unsafe%20%7B%0A%20%20%20%20%20%20%20%20asm!(%22add%20%242%2C%20%240%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20%22%3Dr%22(c)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20%220%22(a)%2C%20%22r%22(b)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20)%3B%0A%20%20%20%20%7D%0A%20%20%20%20c%0A%7D%0A%23%5Bcfg(not(any(target_arch%20%3D%20%22x86%22%2C%20target_arch%20%3D%20%22x86_64%22)))%5D%0Afn%20add(a%3A%20i32%2C%20b%3A%20i32)%20-%3E%20i32%20%7B%20a%20%2B%20b%20%7D%0A%0Afn%20main()%20%7B%0A%20%20%20%20assert_eq!(add(3%2C%2014159)%2C%2014162)%0A%7D%0A&amp;version=nightly">Run</a></pre>

<p>Однако, если вы захотите использовать реальные операнды (регистры) в этой
позиции, то вам потребуется заключить используемый регистр в фигурные скобки
<code>{}</code>, и вы должны будете указать конкретный размер операнда. Это полезно для
очень низкоуровневого программирования, когда важны регистры, которые вы
используете:</p>

<pre class="rust rust-example-rendered">
<span class="kw">let</span> <span class="ident">result</span>: <span class="ident">u8</span>;
<span class="macro">asm</span><span class="macro">!</span>(<span class="string">&quot;in %dx, %al&quot;</span> : <span class="string">&quot;={al}&quot;</span>(<span class="ident">result</span>) : <span class="string">&quot;{dx}&quot;</span>(<span class="ident">port</span>));
<span class="ident">result</span><a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Bfeature(asm)%5D%0Afn%20main()%20%7B%0A%23%5Bcfg(any(target_arch%20%3D%20%22x86%22%2C%20target_arch%20%3D%20%22x86_64%22))%5D%0Aunsafe%20fn%20read_byte_in(port%3A%20u16)%20-%3E%20u8%20%7B%0Alet%20result%3A%20u8%3B%0Aasm!(%22in%20%25dx%2C%20%25al%22%20%3A%20%22%3D%7Bal%7D%22(result)%20%3A%20%22%7Bdx%7D%22(port))%3B%0Aresult%0A%7D%0A%7D&amp;version=nightly">Run</a></pre>

<h2 id='Затираемое-clobbers' class='section-header'><a href='#Затираемое-clobbers'>Затираемое (Clobbers)</a></h2>
<p>Некоторые инструкции могут изменять значения регистров, поэтому мы используем
список затираемого. Он указывает компилятору, что тот не должен допускать
какого-либо изменение значений этих регистров, чтобы они оставались корректными.</p>

<pre class="rust rust-example-rendered">
<span class="comment">// Put the value 0x200 in eax</span>
<span class="macro">asm</span><span class="macro">!</span>(<span class="string">&quot;mov $$0x200, %eax&quot;</span> : <span class="comment">/* no outputs */</span> : <span class="comment">/* no inputs */</span> : <span class="string">&quot;{eax}&quot;</span>);<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Bfeature(asm)%5D%0A%23%5Bcfg(any(target_arch%20%3D%20%22x86%22%2C%20target_arch%20%3D%20%22x86_64%22))%5D%0Afn%20main()%20%7B%20unsafe%20%7B%0A%2F%2F%20Put%20the%20value%200x200%20in%20eax%0Aasm!(%22mov%20%24%240x200%2C%20%25eax%22%20%3A%20%2F*%20no%20outputs%20*%2F%20%3A%20%2F*%20no%20inputs%20*%2F%20%3A%20%22%7Beax%7D%22)%3B%0A%7D%20%7D%0A&amp;version=nightly">Run</a></pre>

<p>Если входные и выходные регистры уже заданы в ограничениях, то их не нужно
перечислять здесь. В противном случае, любые другие регистры, используемые явно
или неявно, должны быть перечислены.</p>

<p>Если ассемблер изменяет регистр кода условия <code>cc</code>, то он должен быть указан в
качестве одного из затираемых. Точно так же, если ассемблер модифицирует память,
то должно быть указано <code>memory</code>.</p>

<h2 id='Опции' class='section-header'><a href='#Опции'>Опции</a></h2>
<p>Последний раздел, <code>options</code>, специфичен для Rust. Формат представляет собой
разделенные запятыми текстовые строки (т.е. <code>:&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;</code>). Он
используется для того, чтобы задать некоторые дополнительные данные для
встроенного ассемблера:</p>

<p>На текущий момент разрешены следующие опции:</p>

<ol>
<li><p><em>volatile</em> — эта опция аналогична <code>__asm__ __volatile__ (...)</code> в gcc/clang;</p></li>
<li><p><em>alignstack</em> — некоторые инструкции ожидают, что стек был выровнен
определенным образом (т.е. SSE), и эта опция указывает компилятору вставить
свой обычный код выравнивания стека;</p></li>
<li><p><em>intel</em> — эта опция указывает использовать синтаксис Intel вместо
используемого по умолчанию синтаксиса AT&amp;T.</p></li>
</ol>

<pre class="rust rust-example-rendered">
<span class="kw">let</span> <span class="ident">result</span>: <span class="ident">i32</span>;
<span class="kw">unsafe</span> {
   <span class="macro">asm</span><span class="macro">!</span>(<span class="string">&quot;mov eax, 2&quot;</span> : <span class="string">&quot;={eax}&quot;</span>(<span class="ident">result</span>) : : : <span class="string">&quot;intel&quot;</span>)
}
<span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;eax is currently {}&quot;</span>, <span class="ident">result</span>);<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Bfeature(asm)%5D%0A%23%5Bcfg(any(target_arch%20%3D%20%22x86%22%2C%20target_arch%20%3D%20%22x86_64%22))%5D%0Afn%20main()%20%7B%0Alet%20result%3A%20i32%3B%0Aunsafe%20%7B%0A%20%20%20asm!(%22mov%20eax%2C%202%22%20%3A%20%22%3D%7Beax%7D%22(result)%20%3A%20%3A%20%3A%20%22intel%22)%0A%7D%0Aprintln!(%22eax%20is%20currently%20%7B%7D%22%2C%20result)%3B%0A%7D%0A&amp;version=nightly">Run</a></pre>

<h2 id='Больше-информации' class='section-header'><a href='#Больше-информации'>Больше информации</a></h2>
<p>Текущая реализация макроса <code>asm!</code> --- это прямое связывание с
<a href="http://llvm.org/docs/LangRef.html#inline-assembler-expressions">встроенным ассемблером LLVM</a>, поэтому изучите и их
<a href="http://llvm.org/docs/LangRef.html#inline-assembler-expressions">документацию</a>, чтобы лучше понять список затираемого, ограничения и
др.</p>

    <script src='../rustbook.js'></script>
</div></div>


</body>
</html>